##### monkeypatchを使用したテスト

```powershell
$ cd python\samplemonkey
$ py -m venv testenv
$ .\testenv\Scripts\Activate.ps1

$ python -m pip install pytest
```

###### 関数（同一モジュール）

- [test_monkey.py](python\samplemonkey\test_monkey.py)

```py
import pytest


import sys
current_module = sys.modules[__name__]


def mock_echo(message: str):
    return 'mock_echo'

def main():
    return echo('Lorem ipsum dolor sit amet, consectetur adipiscing elit.')

def test_main(monkeypatch: pytest.MonkeyPatch):
    monkeypatch.setattr(current_module, 'main', mock_echo)
```

###### 関数（別モジュール）

- [monkey.py](python\samplemonkey\monkey.py)

```py
def echo(message: str):
    return 'echo: ' + message

def main():
    return echo('Lorem ipsum dolor sit amet, consectetur adipiscing elit.')
```

- [test_monkey.py](python\samplemonkey\test_monkey.py)

```py
import pytest


import monkey


def mock_echo(message: str):
    return 'mock_echo'


def mock_main():
    return 'mock_main'


def test_main(monkeypatch: pytest.MonkeyPatch):
    monkeypatch.setattr(monkey, 'echo', mock_echo)
    monkeypatch.setattr(monkey, 'main', mock_main)

    assert monkey.echo('') == 'mock_echo'
    assert monkey.main() == 'mock_main'
```

###### メソッド

- [test_monkey_method.py](python\samplemonkey\test_monkey_method.py)

```py
import pytest


import sys
current_module = sys.modules[__name__]


class MyClass:
    def instance_method1(self):
        return 'instance_method'


def main():
    myClass = MyClass()
    return myClass.instance_method1()


def test_main(monkeypatch: pytest.MonkeyPatch):
    monkeypatch.setattr(current_module.MyClass, 'instance_method1', lambda *args: 'MOCKED')
    assert main() == 'MOCKED'
```

###### クラス

- [test_monkey_class.py](python\samplemonkey\test_monkey_class.py)

```py
import pytest


import sys
current_module = sys.modules[__name__]


class MyClass:
    def instance_method1(self):
        return 'instance_method'


def main():
    myClass = MyClass()
    return myClass.instance_method1()


def test_main(monkeypatch: pytest.MonkeyPatch):
    class MockedClass:
        def instance_method1(self):
            return 'MOCKED'

    monkeypatch.setattr(current_module, 'MyClass', MockedClass)
    assert main() == 'MOCKED'
```

###### 例外

- [test_monkey_exception.py](python\samplemonkey\test_monkey_exception.py)

```py
import pytest


import sys
current_module = sys.modules[__name__]


def mock_main():
    raise Exception('MockException')

def main():
    return echo('Lorem ipsum dolor sit amet, consectetur adipiscing elit.')

def test_main(monkeypatch: pytest.MonkeyPatch):
    monkeypatch.setattr(current_module, 'main', mock_main)

    with pytest.raises(Exception) as e:
        main()
    assert e.value.args[0] == 'MockException'
```

###### 標準出力

- [test_monkey_stdout.py](python\samplemonkey\test_monkey_stdout.py)

```py
import pytest


import sys
current_module = sys.modules[__name__]


class MyClass(object):
    def echo(self):
        print('Lorem ipsum dolor sit amet.')


def test_echo(monkeypatch, capsys):
    monkeypatch.setattr(MyClass, 'echo', lambda x: print('MOCKED'))
    myClass = MyClass()
    actual = myClass.echo()
    actual, _ = capsys.readouterr()
    assert actual == 'MOCKED\n'
```
